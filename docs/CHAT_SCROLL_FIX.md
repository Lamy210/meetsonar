# チャット送信後の画面ずれ修正 - テスト手順

## 🐛 修正した問題
**症状**: チャット送信後に画面が強制的に最下部にスクロールして、ユーザーが意図しない位置に移動してしまう

## ✅ 実装した解決策

### 1. スマートスクロール機能
```tsx
// スクロール位置監視
const checkScrollPosition = useCallback(() => {
    const scrollElement = scrollAreaRef.current?.querySelector('[data-radix-scroll-area-viewport]');
    if (!scrollElement) return;
    
    const { scrollTop, scrollHeight, clientHeight } = scrollElement;
    const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
    const nearBottom = distanceFromBottom < 100; // 100px以内を「最下部近く」と判定
    
    setIsNearBottom(nearBottom);
}, []);
```

### 2. 条件付き自動スクロール
```tsx
// 条件付き自動スクロール
const scrollToBottomIfNeeded = useCallback(() => {
    // ユーザーが最下部近くにいるか、メッセージが少ない場合のみ自動スクロール
    if (isNearBottom || safeMessages.length <= 2) {
        setTimeout(() => scrollToBottom(), 100); // 少し遅延させてDOMの更新を待つ
    }
}, [isNearBottom, safeMessages.length]);
```

### 3. ユーザースクロール検出
- ユーザーが手動でスクロールした場合を検出
- 1秒間のクールダウンを設定
- 自動スクロールを適切に制御

---

## 🧪 テスト手順

### テスト1: 通常のチャット送信
1. **準備**: ブラウザで `http://localhost:5173/` を開く
2. **操作**: 部屋に参加し、チャットタブを開く
3. **操作**: メッセージを送信
4. **期待結果**: ✅ 画面位置が勝手に移動しない

### テスト2: 最下部でのチャット送信
1. **準備**: チャット履歴がある状態で最下部にスクロール
2. **操作**: メッセージを送信
3. **期待結果**: ✅ 新しいメッセージが最下部に表示される

### テスト3: 上部スクロール状態でのチャット送信
1. **準備**: チャット履歴をスクロールして上部を閲覧
2. **操作**: メッセージを送信
3. **期待結果**: ✅ スクロール位置が維持される（強制的に下に移動しない）

### テスト4: 空のチャットでの初回送信
1. **準備**: 新しい部屋で初回メッセージ送信
2. **操作**: メッセージを送信
3. **期待結果**: ✅ メッセージが表示される（メッセージが少ない場合は自動スクロール）

### テスト5: レスポンシブ対応確認
1. **準備**: モバイルサイズ（375px）でテスト
2. **操作**: 各種操作を実行
3. **期待結果**: ✅ 小画面でも同様に動作する

---

## 🔍 技術的詳細

### 修正前の問題
```tsx
// 問題のあったコード
useEffect(() => {
    scrollToBottom(); // 常に強制スクロール
    setForceUpdate(prev => prev + 1);
}, [safeMessages]);
```

### 修正後の改善
```tsx
// 改善されたコード
useEffect(() => {
    scrollToBottomIfNeeded(); // 条件付きスクロール
    setForceUpdate(prev => prev + 1);
}, [safeMessages, scrollToBottomIfNeeded]);
```

### 判定ロジック
- **最下部近く**: スクロール位置が最下部から100px以内
- **メッセージ少数**: 全メッセージ数が2個以下
- **自動スクロール実行**: 上記のいずれかに該当する場合のみ

---

## 📊 期待される改善効果

### ユーザビリティ
- ✅ **スクロール位置の保持**: ユーザーが意図的にスクロールした位置が維持される
- ✅ **適切な自動スクロール**: 必要な場合のみ新しいメッセージへ自動移動
- ✅ **操作の予測可能性**: ユーザーの期待通りの動作

### アクセシビリティ
- ✅ **画面読み上げソフト対応**: 急激な画面移動による混乱を防止
- ✅ **モーション軽減**: 不要なスクロールアニメーションを削減

### パフォーマンス
- ✅ **効率的な監視**: 必要な時のみスクロール位置をチェック
- ✅ **適切な遅延**: DOM更新完了後のスクロール実行

---

## 🐛 既知の制限事項
- ScrollAreaコンポーネント（Radix UI）の内部構造に依存
- 非常に高速なメッセージ送信時の競合状態の可能性

## 🔧 今後の改善予定
- IntersectionObserverを使用したより効率的な監視
- スクロール位置の永続化（ページリロード時の復元）
- カスタマイズ可能なスクロール閾値
