<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React WebSocket Debug</title>
</head>
<body>
    <h1>React WebSocket Debug</h1>
    <div id="debug-info"></div>
    <button onclick="testWebSocket()">Test WebSocket Connection</button>
    <div id="logs" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; margin-top: 10px; padding: 10px; font-family: monospace;"></div>

    <script>
        const debugInfo = document.getElementById('debug-info');
        const logs = document.getElementById('logs');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            entry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function testWebSocket() {
            log('🚀 Starting WebSocket test from browser...');
            
            // Test info
            log(`Browser: ${navigator.userAgent}`);
            log(`Location: ${window.location.href}`);
            log(`WebSocket support: ${!!window.WebSocket}`);

            const wsUrl = `ws://${window.location.host}/ws`;
            log(`WebSocket URL: ${wsUrl}`);

            try {
                const socket = new WebSocket(wsUrl);
                
                socket.onopen = (event) => {
                    log('✅ WebSocket connection opened!', 'success');
                    log(`ReadyState: ${socket.readyState}`);
                    
                    // Test join message
                    const joinMessage = {
                        type: 'join-room',
                        roomId: 'test123',
                        participantId: `browser-test-${Date.now()}`,
                        payload: {
                            displayName: 'BrowserTestUser'
                        }
                    };
                    
                    log(`Sending join message: ${JSON.stringify(joinMessage)}`);
                    
                    try {
                        socket.send(JSON.stringify(joinMessage));
                        log('✅ Message sent successfully!', 'success');
                    } catch (sendError) {
                        log(`❌ Send error: ${sendError.message}`, 'error');
                    }
                    
                    // Test chat message after 2 seconds
                    setTimeout(() => {
                        const chatMessage = {
                            type: 'chat-message',
                            roomId: 'test123',
                            participantId: `browser-test-${Date.now()}`,
                            payload: {
                                message: 'Hello from browser test!',
                                displayName: 'BrowserTestUser'
                            }
                        };
                        
                        log(`Sending chat message: ${JSON.stringify(chatMessage)}`);
                        
                        try {
                            socket.send(JSON.stringify(chatMessage));
                            log('✅ Chat message sent successfully!', 'success');
                        } catch (sendError) {
                            log(`❌ Chat send error: ${sendError.message}`, 'error');
                        }
                    }, 2000);
                };

                socket.onmessage = (event) => {
                    log(`📨 Received: ${event.data}`, 'success');
                };

                socket.onerror = (error) => {
                    log(`❌ WebSocket error: ${error}`, 'error');
                };

                socket.onclose = (event) => {
                    log(`🔌 WebSocket closed: Code ${event.code}, Reason: ${event.reason}`, 'error');
                };

                // Close after 10 seconds
                setTimeout(() => {
                    if (socket.readyState === WebSocket.OPEN) {
                        log('⏰ Closing connection after 10 seconds');
                        socket.close();
                    }
                }, 10000);

            } catch (error) {
                log(`❌ Failed to create WebSocket: ${error.message}`, 'error');
            }
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            setTimeout(testWebSocket, 1000);
        });
    </script>
</body>
</html>
