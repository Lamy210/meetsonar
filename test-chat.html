<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チャット機能テスト</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .message-list { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .message { padding: 5px; margin: 5px 0; background: #f5f5f5; border-radius: 3px; }
        .message.own { background: #e3f2fd; text-align: right; }
        input, button { padding: 8px; margin: 5px; }
        .status { padding: 10px; background: #f0f0f0; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>チャット機能テスト</h1>
    
    <div class="test-section">
        <h2>接続状態</h2>
        <div id="connection-status" class="status">未接続</div>
    </div>

    <div class="test-section">
        <h2>ルーム・参加者設定</h2>
        <input type="text" id="room-id" placeholder="ルームID (例: test-room)" value="test-room">
        <input type="text" id="display-name" placeholder="表示名" value="テストユーザー">
        <button onclick="joinRoom()">ルーム参加</button>
        <button onclick="leaveRoom()">ルーム退出</button>
    </div>

    <div class="test-section">
        <h2>チャット</h2>
        <div id="messages" class="message-list"></div>
        <div>
            <input type="text" id="message-input" placeholder="メッセージを入力..." style="width: 70%;">
            <button onclick="sendMessage()" style="width: 25%;">送信</button>
        </div>
        <button onclick="requestHistory()">履歴を取得</button>
        <button onclick="clearMessages()">メッセージをクリア</button>
    </div>

    <div class="test-section">
        <h2>デバッグ情報</h2>
        <div id="debug-log" style="height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        let ws = null;
        let roomId = null;
        let displayName = null;
        let messageCount = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const debugLog = document.getElementById('debug-log');
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            debugLog.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = status;
            statusEl.style.backgroundColor = 
                status === '接続済み' ? '#c8e6c9' : 
                status === '接続中...' ? '#fff3e0' : '#ffcdd2';
        }

        function joinRoom() {
            roomId = document.getElementById('room-id').value || 'test-room';
            displayName = document.getElementById('display-name').value || 'テストユーザー';
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('既に接続済みです', 'warn');
                return;
            }

            log(`ルーム参加開始: ${roomId}, 表示名: ${displayName}`);
            updateConnectionStatus('接続中...');

            // WebSocket接続
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                log('WebSocket接続成功');
                updateConnectionStatus('接続済み');
                
                // ルーム参加メッセージ送信
                const joinMessage = {
                    type: "join-room",
                    roomId: roomId,
                    participantId: displayName,
                    payload: { displayName: displayName }
                };
                ws.send(JSON.stringify(joinMessage));
                log(`ルーム参加メッセージ送信: ${JSON.stringify(joinMessage)}`);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    log(`受信: ${JSON.stringify(message)}`);
                    handleMessage(message);
                } catch (error) {
                    log(`メッセージ解析エラー: ${error.message}`, 'error');
                }
            };

            ws.onclose = () => {
                log('WebSocket接続が閉じられました');
                updateConnectionStatus('切断');
            };

            ws.onerror = (error) => {
                log(`WebSocketエラー: ${error}`, 'error');
                updateConnectionStatus('エラー');
            };
        }

        function leaveRoom() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const leaveMessage = {
                    type: "leave-room",
                    roomId: roomId,
                    participantId: displayName,
                    payload: {}
                };
                ws.send(JSON.stringify(leaveMessage));
                log(`ルーム退出メッセージ送信: ${JSON.stringify(leaveMessage)}`);
                ws.close();
            }
            updateConnectionStatus('未接続');
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) {
                log('メッセージが空です', 'warn');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocketが接続されていません', 'error');
                return;
            }

            const chatMessage = {
                type: 'chat-message',
                roomId: roomId,
                participantId: displayName,
                payload: {
                    displayName: displayName,
                    message: message,
                    type: 'text'
                }
            };

            ws.send(JSON.stringify(chatMessage));
            log(`チャットメッセージ送信: ${JSON.stringify(chatMessage)}`);
            messageInput.value = '';
        }

        function requestHistory() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocketが接続されていません', 'error');
                return;
            }

            const historyMessage = {
                type: 'chat-history',
                roomId: roomId
            };

            ws.send(JSON.stringify(historyMessage));
            log(`チャット履歴リクエスト送信: ${JSON.stringify(historyMessage)}`);
        }

        function handleMessage(message) {
            switch (message.type) {
                case 'participants-list':
                    log(`参加者リスト受信: ${message.payload.length}人`);
                    break;
                
                case 'participant-joined':
                    log(`参加者が参加: ${message.payload.displayName}`);
                    break;
                
                case 'participant-left':
                    log(`参加者が退出: ${message.payload.displayName}`);
                    break;
                
                case 'chat-message':
                    addMessageToUI(message.payload, false);
                    log(`チャットメッセージ受信: ${message.payload.displayName}: ${message.payload.message}`);
                    break;
                
                case 'chat-history':
                    log(`チャット履歴受信: ${message.payload.length}件`);
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';
                    message.payload.forEach(msg => addMessageToUI(msg, true));
                    break;
                
                case 'error':
                    log(`エラーメッセージ受信: ${message.message}`, 'error');
                    break;
                
                default:
                    log(`未知のメッセージタイプ: ${message.type}`, 'warn');
            }
        }

        function addMessageToUI(messageData, isHistory = false) {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            
            const isOwn = messageData.participantId === displayName;
            if (isOwn) messageEl.classList.add('own');
            
            const timestamp = new Date(messageData.createdAt).toLocaleTimeString();
            messageEl.innerHTML = `
                <strong>${messageData.displayName}</strong> 
                <span style="font-size: 0.8em; color: #666;">${timestamp}</span><br>
                ${messageData.message}
            `;
            
            if (isHistory) {
                messagesDiv.appendChild(messageEl);
            } else {
                messagesDiv.appendChild(messageEl);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            log('UIのメッセージをクリアしました');
        }

        // Enter キーでメッセージ送信
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ページ読み込み時の初期化
        window.addEventListener('load', () => {
            log('チャット機能テストページが読み込まれました');
        });

        // ページを閉じる時の cleanup
        window.addEventListener('beforeunload', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                leaveRoom();
            }
        });
    </script>
</body>
</html>
